<!DOCTYPE html> <html> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>03 ConfigMaps and Secrets | Senalyst </title> <meta name="author" content="Senalyst "> <meta name="description" content="Most content in this document comes from " learn kubernetes in a month of lunches> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="https://seyoungnam.github.io/_k8s/03-config/"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js"></script> <script src="/assets/js/dark_mode.js"></script> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script src="/assets/js/distillpub/template.v2.js"></script> <script src="/assets/js/distillpub/transforms.v2.js"></script> <script src="/assets/js/distillpub/overrides.js"></script> <style type="text/css">.fake-img{background:#bbb;border:1px solid rgba(0,0,0,0.1);box-shadow:0 0 4px rgba(0,0,0,0.1);margin-bottom:12px}.fake-img p{font-family:monospace;color:white;text-align:left;margin:12px 0;text-align:center;font-size:16px}</style> </head> <body> <d-front-matter> <script async type="text/json">{
      "title": "03 ConfigMaps and Secrets",
      "description": "Most content in this document comes from "Learn Kubernetes in a Month of Lunches".",
      "published": "May 15, 2022",
      "authors": [
        {
          "author": "Elton Stoneman",
          "authorURL": "https://www.linkedin.com/in/eltonstoneman/?originalSubdomain=uk",
          "affiliations": [
            {
              "name": "Sixeyed Consulting",
              "url": ""
            }
          ]
        }
        
      ],
      "katex": {
        "delimiters": [
          {
            "left": "$",
            "right": "$",
            "display": false
          },
          {
            "left": "$$",
            "right": "$$",
            "display": true
          }
        ]
      }
    }</script> </d-front-matter> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">Senalyst </span></a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about</a> </li> <li class="nav-item "> <a class="nav-link" href="/blog/">blog</a> </li> <li class="nav-item dropdown "> <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">technology</a> <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown"> <a class="dropdown-item" href="/go/">Golang</a> <div class="dropdown-divider"></div> <a class="dropdown-item" href="/k8s/">Kubernetes</a> <div class="dropdown-divider"></div> <a class="dropdown-item" href="/istio/">Istio</a> <div class="dropdown-divider"></div> <a class="dropdown-item" href="/network/">Network</a> </div> </li> <li class="nav-item dropdown "> <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">algorithms</a> <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown"> <a class="dropdown-item" href="/leetcode/">LeetCode</a> <div class="dropdown-divider"></div> <a class="dropdown-item" href="/algoexpert/">AlgoExpert</a> </div> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects</a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="post distill"> <d-title> <h1>03 ConfigMaps and Secrets</h1> <p>Most content in this document comes from "Learn Kubernetes in a Month of Lunches".</p> </d-title> <d-byline></d-byline> <d-article> <d-contents> <nav class="l-text figcaption"> <h3>Contents</h3> <div><a href="#1-why-are-services-necessary-for-routing-traffic-in-kubernetes">1. Why are Services necessary for routing traffic in Kubernetes</a></div> <div><a href="#2-how-services-route-traffic">2. How Services route traffic</a></div> <div><a href="#3-the-simplest-service-yaml-spec">3. The simplest Service YAML spec</a></div> <div><a href="#4-three-scenarios-of-routing-traffic">4. Three scenarios of routing traffic</a></div> <div><a href="#5-understanding-kubernetes-service-resolution">5. Understanding Kubernetes Service resolution</a></div> </nav> </d-contents> <h2 id="1-environment-variables-configmaps-and-secrets">1. Environment variables, ConfigMaps, and Secrets</h2> <p>Environment variables are variables applied to your program/application dynamically during runtime, based on which the way your program/application acts is different. Examples of environment variables are a password of the database running for your app, paths for packages/libraries that your code depends on, and go build variables (GOARCH, GOOS) to create a binary file that conforms to your system.</p> <p>ConfigMaps and Secrets are kubernetes resources to supply environment variables to the Pod your application is running on. They are just storage units intended for small amounts of data. Those storage units can be loaded into a Pod, becoming part of the container environment, so that application in the container can read the data.</p> <h2 id="2-four-ways-to-add-environment-variables-in-the-pod">2. Four ways to add environment variables in the Pod</h2> <ul> <li>Directly specify environment variables in the Pod spec</li> <li>Create a ConfigMap from literal values and load it into the Pod</li> <li>Create a ConfigMap populated from the environment file and load it into the Pod</li> <li>Create a ConfigMap containing key-value pairs and load it into the Pod</li> </ul> <h3 id="21-directly-specify-environment-variables-in-the-pod-spec">2.1. Directly specify environment variables in the Pod spec</h3> <p>In the below example, <code class="language-plaintext highlighter-rouge">KIAMOL_CHAPTER</code> is specified at <code class="language-plaintext highlighter-rouge">spec.template.spec.containers.env</code> of the Deployment yaml spec.</p> <figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">sleep</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">sleep</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">sleep</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">sleep</span>
          <span class="na">image</span><span class="pi">:</span> <span class="s">kiamol/ch03-sleep</span>
          <span class="na">env</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">KIAMOL_CHAPTER</span>
            <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">04"</span></code></pre></figure> <p>It is the most straight-forward way to supply environment variables to the Pod. A downside of it is that if you need to make configuration changes you need to perform an update with a replacement Pod, which will results in frequent Pod replacements.</p> <h3 id="22-create-configmaps-from-literal-values-and-load-it-into-the-pod">2.2. Create ConfigMaps from literal values and load it into the Pod</h3> <p>Real application usually have more complex configuration requirements, which is when you use ConfigMaps. As mentioned above, ConfigMaps are just a storage unit that has data in the form of key-value pairs. To load a ConfigMap into a Pod, the ConfigMap needs to exist before you deploy the Pod. Below is the kubectl command to create a ConfigMap.</p> <figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="c"># create a ConfigMap with data from the command line:</span>
❯ kubectl create configmap sleep-config-literal <span class="nt">--from-literal</span><span class="o">=</span>kiamol.section<span class="o">=</span><span class="s1">'4.1'</span>
error: failed to create configmap: configmaps <span class="s2">"sleep-config-literal"</span> already exists

<span class="c"># check the ConfigMap details:</span>
❯ kubectl get cm sleep-config-literal
NAME                   DATA   AGE
sleep-config-literal   1      47h</code></pre></figure> <p>Then deploy the updated app to use the ConfigMap.</p> <figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">sleep</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">sleep</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">sleep</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">sleep</span>
          <span class="na">image</span><span class="pi">:</span> <span class="s">kiamol/ch03-sleep</span>
          <span class="na">env</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">KIAMOL_CHAPTER</span>
            <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">04"</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">KIAMOL_SECTION</span>              <span class="c1"># a new env var from ConfigMap </span>
            <span class="na">valueFrom</span><span class="pi">:</span>
              <span class="na">configMapKeyRef</span><span class="pi">:</span>              
                <span class="na">name</span><span class="pi">:</span> <span class="s">sleep-config-literal</span>    <span class="c1"># ConfigMap name</span>
                <span class="na">key</span><span class="pi">:</span> <span class="s">kiamol.section</span>           <span class="c1"># the data item to load</span></code></pre></figure> <p>After deploying the above yaml spec, check the <code class="language-plaintext highlighter-rouge">KIAMOL_SECTION</code> environment variable.</p> <figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="c"># create a ConfigMap with data from the command line:</span>
❯ kubectl <span class="nb">exec </span>deploy/sleep <span class="nt">--</span> sh <span class="nt">-c</span> <span class="s1">'printenv | grep "^KIAMOL"'</span>
<span class="nv">KIAMOL_CHAPTER</span><span class="o">=</span>04</code></pre></figure> <h3 id="23-create-a-new-configmap-populated-from-the-environment-file-and-load-it-into-the-pod">2.3. Create a new ConfigMap populated from the environment file and load it into the Pod</h3> <p>To supply a lot of configuration data in one scoop, create an environment file that can be loaded to create a ConfigMap is a good option to consider. For example, save a file <code class="language-plaintext highlighter-rouge">ch04.env</code> with the following content.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Environment files use a new line for each variable.
KIAMOL_CHAPTER=ch04
KIAMOL_SECTION=ch04-4.1
KIAMOL_EXERCISE=try it now
</code></pre></div></div> <p>Then create a ConfigMap with this env file.</p> <figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="c"># load an environment variable into a new ConfigMap:</span>
❯ kubectl create configmap sleep-config-env-file <span class="nt">--from-env-file</span><span class="o">=</span><span class="nb">sleep</span>/ch04.env
error: failed to create configmap: configmaps <span class="s2">"sleep-config-env-file"</span> already exists
<span class="c"># check the details of the ConfigMap:</span>
❯ kubectl get cm sleep-config-env-file
NAME                    DATA   AGE
sleep-config-env-file   3      47h</code></pre></figure> <p>Next, update the Pod to use the new ConfigMap.</p> <figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">sleep</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">sleep</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">sleep</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">sleep</span>
          <span class="na">image</span><span class="pi">:</span> <span class="s">kiamol/ch03-sleep</span>
          <span class="na">envFrom</span><span class="pi">:</span>                            <span class="c1"># newly added block to reference a ConfigMap</span>
          <span class="pi">-</span> <span class="na">configMapRef</span><span class="pi">:</span>                     <span class="c1"># newly added block to refernece a ConfigMap</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s">sleep-config-env-file</span>     <span class="c1"># newly added block to refernece a ConfigMap</span>
          <span class="na">env</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">KIAMOL_CHAPTER</span>
            <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">04"</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">KIAMOL_SECTION</span>
            <span class="na">valueFrom</span><span class="pi">:</span>
              <span class="na">configMapKeyRef</span><span class="pi">:</span>              
                <span class="na">name</span><span class="pi">:</span> <span class="s">sleep-config-literal</span>
                <span class="na">key</span><span class="pi">:</span> <span class="s">kiamol.section</span></code></pre></figure> <p>After deploying a new Deployment yaml spec, print out the environment variables. You will meet the interesting facts.</p> <figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="c"># update the Pod to use the new ConfigMap:</span>
❯ kubectl apply <span class="nt">-f</span> <span class="nb">sleep</span>/sleep-with-configMap-env-file.yaml
deployment.apps/sleep configured
<span class="c"># check the values in the container:</span>
❯ kubectl <span class="nb">exec </span>deploy/sleep <span class="nt">--</span> sh <span class="nt">-c</span> <span class="s1">'printenv | grep "^KIAMOL"'</span>
error: unable to upgrade connection: container not found <span class="o">(</span><span class="s2">"sleep"</span><span class="o">)</span>
snam@C02FL4Y9MD6T ch04 % kubectl <span class="nb">exec </span>deploy/sleep <span class="nt">--</span> sh <span class="nt">-c</span> <span class="s1">'printenv | grep "^KIAMOL"'</span>
<span class="nv">KIAMOL_EXERCISE</span><span class="o">=</span>try it now
<span class="nv">KIAMOL_SECTION</span><span class="o">=</span>4.1
<span class="nv">KIAMOL_CHAPTER</span><span class="o">=</span>04</code></pre></figure> <blockquote> <p>When the same environment variable is supplied by multiple sources(one by ConfigMap defined under <code class="language-plaintext highlighter-rouge">env</code> and the other under <code class="language-plaintext highlighter-rouge">envFrom</code> in this example), the environment variables defined with <code class="language-plaintext highlighter-rouge">env</code> in the Pod spec override the values defined with <code class="language-plaintext highlighter-rouge">envFrom</code>.</p> </blockquote> <h3 id="23-create-a-configmap-containing-key-value-pairs-and-load-it-into-the-pod">2.3. Create a ConfigMap containing key-value pairs and load it into the Pod</h3> <p>This will be the most common way to use a ConfigMap. Key-value pairs for environment variables will be specified in the <code class="language-plaintext highlighter-rouge">data</code> section inside of ConfigMap. Please refer to the below example.</p> <figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ConfigMap</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">todo-web-config-dev</span>
<span class="na">data</span><span class="pi">:</span>
  <span class="na">config.json</span><span class="pi">:</span> <span class="pi">|-</span>
    <span class="s">{</span>
      <span class="s">"ConfigController": {</span>
        <span class="s">"Enabled" : true</span>
      <span class="s">}</span>
    <span class="s">}</span></code></pre></figure> <p>The Pod bound with <code class="language-plaintext highlighter-rouge">todo-web</code> Deployment(see the spec below) will load this ConfigMap and mount <code class="language-plaintext highlighter-rouge">config.json</code> file onto the path <code class="language-plaintext highlighter-rouge">/app/config</code> in the container. The ConfigMap is treated like a directory.</p> <figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">todo-web</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">todo-web</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">todo-web</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">web</span>
          <span class="na">image</span><span class="pi">:</span> <span class="s">kiamol/ch04-todo-list</span> 
          <span class="na">volumeMounts</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">config</span>
              <span class="na">mountPath</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/app/config"</span>      <span class="c1"># ConfigMap mounted path </span>
              <span class="na">readOnly</span><span class="pi">:</span> <span class="kc">true</span>
      <span class="na">volumes</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">config</span>
          <span class="na">configMap</span><span class="pi">:</span>
            <span class="na">name</span><span class="pi">:</span> <span class="s">todo-web-config-dev</span>       <span class="c1"># Names a ConfigMap to load</span></code></pre></figure> <h2 id="3-hierarchy-of-configuration-sources">3. Hierarchy of configuration sources</h2> <ol> <li>Default settings are baked into the container image.</li> <li>The actual settings for each environment are stored in a ConfigMap and surfaced into the container filesystem.</li> <li>Any settings that need to be tweaked can be applied as environment variables in the Pod spec for the Deployment.</li> </ol> <h2 id="4-two-ways-to-configure-sensitive-data-with-secrets">4. Two ways to configure sensitive data with Secrets</h2> <ul> <li>Reference a Secret object directly in the Pod</li> <li>Load a sensitive data into a file and reference the file location in the Pod</li> </ul> <h3 id="41-reference-a-secret-object-directly-in-the-pod">4.1. Reference a Secret object directly in the Pod</h3> <figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="c"># now create a secret from a plain text literal:</span>
❯ kubectl create secret generic sleep-secret-literal <span class="nt">--from-literal</span><span class="o">=</span><span class="nv">secret</span><span class="o">=</span>shh...
deployment.apps/todo-web created

<span class="c"># show the friendly details of the Secret:</span>
❯ kubectl describe secret sleep-secret-literal
Name:         sleep-secret-literal
Namespace:    default
Labels:       &lt;none&gt;
Annotations:  &lt;none&gt;

Type:  Opaque

Data
<span class="o">====</span>
secret:  6 bytes

<span class="c"># retrieve the encoded Secret value:</span>
❯ kubectl get secret sleep-secret-literal <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.data.secret}'</span>
c2hoLi4u%  

<span class="c"># and decode the data:</span>
❯ kubectl get secret sleep-secret-literal <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.data.secret}'</span> | <span class="nb">base64</span> <span class="nt">-d</span>
shh...%  </code></pre></figure> <blockquote> <p>Creating Secrets from a literal value is equivalent to base64 encoding, which isn’t really a security feature but just does prevent accidental exposure of secrets to someone looking over your shoulder.</p> </blockquote> <p>The way to load Secrets to the Pod is almost the same with ConfigMaps, as you can see below.</p> <figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">sleep</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">sleep</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">sleep</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">sleep</span>
          <span class="na">image</span><span class="pi">:</span> <span class="s">kiamol/ch03-sleep</span>
          <span class="na">env</span><span class="pi">:</span>                                <span class="c1"># Environment variables</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">KIAMOL_SECRET</span>               <span class="c1"># Variable name in the container</span>
            <span class="na">valueFrom</span><span class="pi">:</span>                        <span class="c1"># loaded from an external source  </span>
              <span class="na">secretKeyRef</span><span class="pi">:</span>                   <span class="c1"># which is a Secret       </span>
                <span class="na">name</span><span class="pi">:</span> <span class="s">sleep-secret-literal</span>    <span class="c1"># Names the Secret</span>
                <span class="na">key</span><span class="pi">:</span> <span class="s">secret</span>                   <span class="c1"># Key of the Secret data item</span></code></pre></figure> <p>Confirm that <code class="language-plaintext highlighter-rouge">KIAMOL_SECRET</code> is supplied to the Pod.</p> <figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="c"># update the sleep Deployment:</span>
❯ kubectl apply <span class="nt">-f</span> <span class="nb">sleep</span>/sleep-with-secret.yaml
deployment.apps/sleep configured

<span class="c"># check the environment variable in the Pod:</span>
❯ kubectl <span class="nb">exec </span>deploy/sleep <span class="nt">--</span> <span class="nb">printenv </span>KIAMOL_SECRET
shh...</code></pre></figure> <p>As you can observe in this case, the sensitive data provided by a literal Secret is easily exposed. Providing a sensitive data in a Secret yaml spec like below has the same issue.</p> <figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Secret</span>                            <span class="c1"># Secret is the resource type.</span>
<span class="na">metadata</span><span class="pi">:</span>
 <span class="na">name</span><span class="pi">:</span> <span class="s">todo-db-secret-test</span>             <span class="c1"># Names the Secret</span>
<span class="na">type</span><span class="pi">:</span> <span class="s">Opaque</span>                            <span class="c1"># Opaque secrets are for text data.</span>
<span class="na">stringData</span><span class="pi">:</span>                             <span class="c1"># stringData is for plain text.</span>
 <span class="na">POSTGRES_PASSWORD</span><span class="pi">:</span> <span class="s2">"</span><span class="s">kiamol-2*2*"</span>      <span class="c1"># The secret key and value.</span></code></pre></figure> <h3 id="42-load-a-sensitive-data-into-a-file-and-reference-the-file-location-in-the-pod">4.2. Load a sensitive data into a file and reference the file location in the Pod</h3> <figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Secret</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">todo-db-secret-test</span>
<span class="na">type</span><span class="pi">:</span> <span class="s">Opaque</span>
<span class="na">stringData</span><span class="pi">:</span>
  <span class="na">POSTGRES_PASSWORD</span><span class="pi">:</span> <span class="s2">"</span><span class="s">kiamol-2*2*"</span></code></pre></figure> <figure class="highlight"><pre><code class="language-yaml" data-lang="yaml">    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">db</span>
          <span class="na">image</span><span class="pi">:</span> <span class="s">postgres:11.6-alpine</span>
          <span class="na">env</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">POSTGRES_PASSWORD_FILE</span>          <span class="c1"># Sets the path to the file</span>
            <span class="na">value</span><span class="pi">:</span> <span class="s">/secrets/postgres_password</span>
          <span class="na">volumeMounts</span><span class="pi">:</span>                           <span class="c1"># Mounts a Secret volume</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">secret</span>                        <span class="c1"># Names the volume</span>
              <span class="na">mountPath</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/secrets"</span>
      <span class="na">volumes</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">secret</span>
          <span class="na">secret</span><span class="pi">:</span>                                 <span class="c1"># Volume loaded from a Secret </span>
            <span class="na">secretName</span><span class="pi">:</span> <span class="s">todo-db-secret-test</span>       <span class="c1"># Secret name</span>
            <span class="na">defaultMode</span><span class="pi">:</span> <span class="m">0400</span>                     <span class="c1"># Permissions to set for files</span>
            <span class="na">items</span><span class="pi">:</span>                                <span class="c1"># Optionally names the data items</span>
            <span class="pi">-</span> <span class="na">key</span><span class="pi">:</span> <span class="s">POSTGRES_PASSWORD</span>
              <span class="na">path</span><span class="pi">:</span> <span class="s">postgres_password</span></code></pre></figure> <p>Look at the above Pod spec. The value for <code class="language-plaintext highlighter-rouge">POSTGRES_PASSWORD_FILE</code> is not a sensitive data itself but a path where the data is stored. When this Pod is deployed, Kubernetes loads the value of the Secret item into a file at the path <code class="language-plaintext highlighter-rouge">/secrets/postgres_password</code>. That file will be set with 0400 permissions, which means it can be read by the container user but not by any other users, which effectively minimizes the exposure of the sensitive data.</p> </d-article> <d-appendix> <d-footnote-list></d-footnote-list> <d-citation-list></d-citation-list> </d-appendix> <d-bibliography src="/assets/bibliography/"></d-bibliography><div id="giscus_thread" style="max-width: 800px; margin: 0 auto;"> <script>let giscusTheme=localStorage.getItem("theme"),giscusAttributes={src:"https://giscus.app/client.js","data-repo":"alshedivat/al-folio","data-repo-id":"MDEwOlJlcG9zaXRvcnk2MDAyNDM2NQ==","data-category":"Comments","data-category-id":"DIC_kwDOA5PmLc4CTBt6","data-mapping":"title","data-strict":"1","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"bottom","data-theme":giscusTheme,"data-lang":"en",crossorigin:"anonymous",async:""},giscusScript=document.createElement("script");Object.entries(giscusAttributes).forEach(([t,a])=>giscusScript.setAttribute(t,a)),document.getElementById("giscus_thread").appendChild(giscusScript);</script> <noscript>Please enable JavaScript to view the <a href="http://giscus.app/?ref_noscript" rel="external nofollow noopener" target="_blank">comments powered by giscus.</a> </noscript> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2024 Senalyst . Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="external nofollow noopener">Unsplash</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>